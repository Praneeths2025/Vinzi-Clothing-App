<!--
  Vinzi Clothing — Home
  Version: v01.03.04
  Date: 2025-09-26 22:15 (Asia/Colombo)

  Changes in this version:
  [v01.03.04] Top nav: highlight "Shop" on /pages/shop.html (and keep "Home" on /).
              Functional menu: parents with children do not navigate; only leaf items navigate.
              Added event delegation for functional menu clicks.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Vinzi Clothing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
  <link rel="preload" as="style"
        href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700&family=Playfair+Display:wght@400;500;700;900"
        onload="this.rel='stylesheet'">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style type="text/tailwindcss">
    :root {
      --neutral-900: #1c1c0d;
      --neutral-700: #545427;
      --neutral-200: #e0e0a0;
      --background: #fcfcf8;
      --beige: #A6845A;         /* prices */
      --active-green: #17a34a;  /* active/selected state */
    }
    html { scroll-behavior: smooth; }
    body { min-height: max(884px, 100dvh); }

    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    .no-scrollbar::-webkit-scrollbar { display:none; }

    /* Arrow buttons for carousels */
    .arrow-btn {
      @apply absolute top-1/2 -translate-y-1/2 z-10 bg-white/90 border border-[var(--neutral-200)] shadow-sm rounded-full w-10 h-10 grid place-items-center hover:bg-white;
    }
    .arrow-icon { font-variation-settings: "wght" 600; }

    /* Exact-width carousel (no half cards) */
    .row-track {
      --pv: 2;         /* cards per view (mobile) */
      --gap: 1rem;
      display: grid;
      grid-auto-flow: column;
      gap: var(--gap);
      grid-auto-columns: calc((100% - (var(--gap) * (var(--pv) - 1))) / var(--pv));
      scroll-snap-type: x mandatory;
    }
    @media (min-width: 640px) {
      .row-track { --pv: 4; --gap: 1.5rem; } /* desktop */
    }
    .row-card { scroll-snap-align: start; }

    /* Top main menu */
    .main-nav a.active { color: var(--active-green); font-weight: 700; }

    /* Hover: dark green + bold (header, functional, dropdown) */
    .main-nav a:hover,
    #functionalNav a:hover,
    .submenu a:hover {
      color: #c09e09;   /* dark green */
      font-weight: 700; /* bold */
    }

    /* Functional menu (DB-driven) */
    .func-nav a.active { color: var(--active-green); font-weight: 700; }

    .dropdown { @apply relative; }
    /* keep submenu tight and sticky to parent */
    .dropdown > .submenu {
      @apply invisible opacity-0 absolute left-0 top-full mt-0 min-w-[12rem]
             rounded-none border border-[var(--neutral-200)] bg-white shadow-md ring-1 ring-black/5
             transition-opacity z-50 pointer-events-auto;
    }
    .dropdown:hover > .submenu,
    .dropdown:focus-within > .submenu {
      @apply visible opacity-100;
    }
    .submenu a {
      @apply block px-4 py-2 text-sm whitespace-nowrap hover:bg-[color:color-mix(in_oklab,white,#000_4%)];
    }
    /* never clip dropdowns */
    #functionalNav, #functionalNav > div { overflow: visible; }

    /* === Size chips + disabled Add button (kept) === */
    .size-btn {
      @apply inline-flex items-center justify-center rounded-full border text-xs font-medium px-2.5 py-1.5;
      background-color: transparent;
      color: #fff;
      border-color: #fff;
    }
    .size-btn:hover { background-color:#000; color:#fff; }
    .size-btn[aria-pressed="true"] { background-color:#fff; color:#000; border-color:#000; }
    .add-btn:disabled { @apply opacity-50 cursor-not-allowed; }
  </style>
  <link rel="stylesheet" href="/assets/styles/overrides.css">
</head>

<body class="font-sans bg-[var(--background)] text-[var(--neutral-900)]">
  <div class="min-h-screen flex flex-col overflow-x-hidden">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-[var(--background)]/90 backdrop-blur-sm border-b border-[var(--neutral-200)]">
      <div class="mx-auto max-w-7xl grid grid-cols-3 items-center px-4 sm:px-6 py-4">
        <!-- Left: Logo -->
        <a href="/" class="flex items-center gap-2">
          <img src="/assets/uploads/vinzi-logo.png" alt="Vinzi Clothing" class="h-20 w-auto object-contain">
          <span class="sr-only">Vinzi Clothing</span>
        </a>

        <!-- Center: MAIN menu (static) -->
        <nav class="main-nav flex items-center justify-center gap-7 text-[15px]">
          <a id="nav-home"    href="/"                   class="transition">Home</a>
          <a id="nav-shop"    href="/pages/shop.html"    class="transition">Shop</a>
          <a id="nav-about"   href="/pages/about.html"   class="transition">About</a>
          <a id="nav-faq"     href="/pages/faq.html"     class="transition">FAQ</a>
          <a id="nav-contact" href="/pages/contact.html" class="transition">Contact</a>
          <a id="nav-cart"    href="/pages/cart.html"    class="transition flex items-center gap-1">
            <span>Cart</span>
          </a>
        </nav>

        <!-- Right: mobile quick links -->
        <div class="md:hidden flex justify-end gap-3 text-sm">
          <a href="/products" class="hover:underline">Shop</a>
          <a href="/cart" class="hover:underline flex items-center gap-1">
            <span class="material-symbols-outlined text-base">shopping_bag</span> Cart
          </a>
        </div>
      </div>

      <!-- Functional menu (DB-driven) -->
      <nav id="functionalNav" class="func-nav mx-auto max-w-7xl px-4 sm:px-6 py-2 border-t border-[var(--neutral-200)] text-sm"></nav>
    </header>

    <main class="flex-1">
      <!-- Hero -->
      <section class="relative">
        <div class="relative h-[65vh] min-h-[360px] w-full bg-cover bg-center"
             style='background-image:url("/assets/uploads/Background-pic1.png"); filter: brightness(1);'>
          <div class="absolute inset-0 bg-black/25"></div>
          <div class="relative z-10 flex h-full flex-col items-center justify-center gap-4 sm:gap-6 p-8 text-center text-white">
            <h2 class="text-3xl sm:text-4xl font-black tracking-tight" style='font-family:"Playfair Display",serif;'>
              Experience the Elegance of Sri Lankan Batik
            </h2>
            <p class="max-w-md text-xs sm:text-sm leading-relaxed">
              Discover our exquisite collection of handcrafted batik fashion, blending traditional artistry with modern style.
            </p>
            <a href="/pages/shop.html"
               class="rounded-full px-6 py-2 sm:px-8 sm:py-3 bg-black text-white text-sm font-semibold hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-white">
              DISCOVER
            </a>
          </div>
        </div>
      </section>

      <!-- Hand-picked New Arrivals -->
      <section id="new-arrivals" class="py-10">
        <div class="mx-auto max-w-7xl">
          <div class="px-4 sm:px-6 pb-4 flex items-center justify-between">
            <h3 class="text-2xl font-bold" style='font-family:"Playfair Display",serif;'>Hand-picked New Arrivals</h3>
          </div>

          <div id="newArrivalsGrid" class="px-4 sm:px-6 grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 hidden"></div>

          <div class="relative px-4 sm:px-6">
            <button type="button" aria-label="Previous" class="arrow-btn left-0" data-target="newArrivalsRow" data-dir="-1">
              <span class="material-symbols-outlined arrow-icon">chevron_left</span>
            </button>
            <button type="button" aria-label="Next" class="arrow-btn right-0" data-target="newArrivalsRow" data-dir="1">
              <span class="material-symbols-outlined arrow-icon">chevron_right</span>
            </button>

            <div id="newArrivalsRow" class="no-scrollbar overflow-hidden hidden">
              <div id="newArrivalsTrack" class="row-track pb-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Best Sellers -->
      <section id="best-sellers" class="py-6">
        <div class="mx-auto max-w-7xl">
          <div class="px-4 sm:px-6 pb-4 flex items-center justify-between">
            <h3 class="text-2xl font-bold" style='font-family:"Playfair Display",serif;'>Best Sellers</h3>
          </div>

          <div id="bestSellersGrid" class="px-4 sm:px-6 grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 hidden"></div>

          <div class="relative px-4 sm:px-6">
            <button type="button" aria-label="Previous" class="arrow-btn left-0" data-target="bestSellersRow" data-dir="-1">
              <span class="material-symbols-outlined arrow-icon">chevron_left</span>
            </button>
            <button type="button" aria-label="Next" class="arrow-btn right-0" data-target="bestSellersRow" data-dir="1">
              <span class="material-symbols-outlined arrow-icon">chevron_right</span>
            </button>

            <div id="bestSellersRow" class="no-scrollbar overflow-hidden hidden">
              <div id="bestSellersTrack" class="row-track pb-2"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-[var(--neutral-200)] bg-[color:color-mix(in_oklab,var(--background),#000_3%)]">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 py-6 text-sm text-[var(--neutral-700)]">
        <div class="flex flex-col sm:flex-row items-center sm:justify-between gap-3">
          <div class="text-center sm:text-left">
            © <span id="year"></span> Vinzi Clothing. All rights reserved.
          </div>
          <nav class="flex flex-wrap items-center gap-4 text-[13px]">
            <a href="/about" class="hover:underline">About</a>
            <a href="/returns" class="hover:underline">Returns</a>
            <a href="/faq" class="hover:underline">FAQ</a>
            <a href="/contact" class="hover:underline">Contact</a>
          </nav>
        </div>
        <div class="mt-3 flex items-center justify-center sm:justify-end gap-4 text-[13px]">
          <a href="#" aria-label="Facebook" class="opacity-80 hover:opacity-100">Facebook</a>
          <a href="#" aria-label="Instagram" class="opacity-80 hover:opacity-100">Instagram</a>
          <a href="#" aria-label="WhatsApp" class="opacity-80 hover:opacity-100">WhatsApp</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    /* ---------- helpers ---------- */
    const qs  = (s, r = document) => r.querySelector(s);
    const qsa = (s, r = document) => Array.from(r.querySelectorAll(s));
    const getParam = (k) => new URLSearchParams(location.search).get(k);

    /* ---------- ACTIVE state for MAIN menu (Home/Shop/...) ---------- */
    (() => {
      const p = location.pathname.toLowerCase();
      const isHome = (p === '/') || p.endsWith('/index.html') || p.endsWith('/home.html');
      const isShop = p.endsWith('/shop.html');
      const setActive = id => document.getElementById(id)?.classList.add('active');
      if (isHome) setActive('nav-home');
      else if (isShop) setActive('nav-shop');
    })();

    /* ---------- API helper ---------- */
    async function api(path, method="GET", body) {
      const res = await fetch(path, {
        method,
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : undefined,
        credentials: "include"
      });
      return res;
    }

    /* === NEW: normalize sizes from DB === */
    function normalizeSizes(p){
      if (Array.isArray(p.sizesArray) && p.sizesArray.length) return p.sizesArray;
      if (Array.isArray(p.sizes) && p.sizes.length) return p.sizes;
      if (typeof p.sizes === 'string') return p.sizes.split(',').map(s=>s.trim()).filter(Boolean);
      if (Array.isArray(p.variants)) return [...new Set(p.variants.map(v => String(v.size||v.label||'').trim()).filter(Boolean))];
      if (p.stockBySize && typeof p.stockBySize === 'object') return Object.keys(p.stockBySize);
      if (typeof p.size === 'string') return [p.size];
      return [];
    }

    /* ---------- Build FUNCTIONAL menu from DB (/api/menus) ---------- */
    async function buildFunctionalMenu() {
      const el = document.getElementById('functionalNav');
      if (!el) return;

      try {
        const res = await api('/api/menus');
        if (res.ok) {
          const flat = await res.json();
          el.innerHTML = renderFunctionalFromMenus(flat);
          markFunctionalActive();
          attachFunctionalClickHandler();
          return;
        }
      } catch (_) {}

      try {
        const res = await api('/api/categories');
        if (!res.ok) throw new Error();
        const cats = await res.json(); // [{slug,name}]
        el.innerHTML = renderFunctionalFallback(cats);
        markFunctionalActive();
        attachFunctionalClickHandler();
      } catch (_) {
        el.innerHTML = '';
      }
    }

    function renderFunctionalFromMenus(menus) {
      const arr = Array.isArray(menus) ? menus.slice() : [];

      // sort by sortOrder then label
      arr.sort((a,b) => (a.sortOrder ?? 9999) - (b.sortOrder ?? 9999) || String(a.label).localeCompare(String(b.label)));

      // HARD FILTER to avoid header items in the functional row
      const BLOCK = new Set(['home','shop','about','faq','contact','cart','login','register','login / register','blog']);
      const filtered = arr.filter(item => {
        const label = String(item.label || item.name || '').trim().toLowerCase();
        const isHeaderType = (String(item.menuType||'').toLowerCase()==='header') || (String(item.type||'').toLowerCase()==='header');
        if (BLOCK.has(label) || isHeaderType) return false;

        const hasChildren = Array.isArray(item.children) && item.children.length > 0;
        const hasRoute    = !!(item.slug || item.path);
        // keep category-like items (Women/Men/Sarees/etc.)
        return hasChildren || hasRoute;
      });

      const html = filtered.map(item => {
        const label = item.label || item.name || "Menu";
        const slug  = (item.slug || "").toLowerCase();
        const children = Array.isArray(item.children) ? item.children : [];

        if (!children.length) {
          const path = item.path || (slug ? `/products?category=${encodeURIComponent(slug)}` : "#");
          return `<a href="${path}" data-path="/products" data-category="${slug || ""}" data-menu data-has-children="false">${label}</a>`;
        }

        // Parent (has children): do NOT navigate on click
        const sub = children.map(ch => {
          const cLabel = ch.label || ch.name || ch.slug;
          const cSlug  = (ch.slug || "").toLowerCase();
          const cHref  = `/pages/shop.html?category=${encodeURIComponent(cLabel)}`;
          return `<a href="${cHref}" data-path="/products" data-category="${cSlug}" data-menu data-has-children="false" data-category-label="${cLabel}">${cLabel}</a>`;
        }).join("");

        return `
          <div class="dropdown inline-block">
            <a href="#"
               data-path="/products"
               data-category="${slug}"
               data-menu
               data-has-children="true">${label}</a>
            <div class="submenu">${sub}</div>
          </div>
        `;
      }).join("");

      return `<div class="flex items-center gap-6 overflow-visible">${html}</div>`;
    }

    function renderFunctionalFallback(cats) {
      const list = Array.isArray(cats) ? cats : [];
      const bySlug = new Map(list.map(c => [String(c.slug||"").toLowerCase(), c]));
      const mk = (slug, label) => `<a href="/products?category=${encodeURIComponent(slug)}" data-path="/products" data-category="${slug}" data-menu data-has-children="false">${label}</a>`;

      const womenSubs = list.filter(c => {
        const s = String(c.slug||"").toLowerCase();
        return s !== "women" && (s.startsWith("women-") || s.startsWith("women_") || s.startsWith("women "));
      }).map(c => `<a href="/pages/shop.html?category=${encodeURIComponent(c.name || c.slug)}" data-path="/products" data-category="${String(c.slug).toLowerCase()}" data-menu data-has-children="false" data-category-label="${c.name || c.slug}">${c.name || c.slug}</a>`)

      const menSubs = list.filter(c => {
        const s = String(c.slug||"").toLowerCase();
        return s !== "men" && (s.startsWith("men-") || s.startsWith("men_") || s.startsWith("men "));
      }).map(c => `<a href="/pages/shop.html?category=${encodeURIComponent(c.name || c.slug)}" data-path="/products" data-category="${String(c.slug).toLowerCase()}" data-menu data-has-children="false" data-category-label="${c.name || c.slug}">${c.name || c.slug}</a>`)

      const parts = [];
      if (bySlug.has("women")) {
        parts.push(`
          <div class="dropdown inline-block">
            <a href="#" data-path="/products" data-category="women" data-menu data-has-children="true">${bySlug.get("women").name || "Women"}</a>
            <div class="submenu">${womenSubs}</div>
          </div>
        `);
      }
      if (bySlug.has("men")) {
        parts.push(`
          <div class="dropdown inline-block">
            <a href="#" data-path="/products" data-category="men" data-menu data-has-children="true">${bySlug.get("men").name || "Men"}</a>
            <div class="submenu">${menSubs}</div>
          </div>
        `);
      }
      list.forEach(c => {
        const s = String(c.slug||"").toLowerCase();
        if (s === "women" || s === "men" || s.startsWith("women-") || s.startsWith("men-")) return;
        parts.push(mk(s, c.name || c.slug));
      });

      return `<div class="flex items-center gap-6 overflow-visible">${parts.join("")}</div>`;
    }

    function attachFunctionalClickHandler() {
      const container = document.getElementById('functionalNav');
      if (!container) return;
      container.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-menu]');
        if (!a) return;
        const hasChildren = (a.dataset.hasChildren || '').toLowerCase() === 'true';

        if (hasChildren) {
          // Parent: block navigation (keeps dropdown usable)
          e.preventDefault();
          e.stopPropagation();
          return;
        }

        // Leaf: allow existing href; if missing, build URL to Shop with filters
        if (!a.getAttribute('href') || a.getAttribute('href') === '#') {
          e.preventDefault();
          const catLbl = a.dataset.categoryLabel || '';
          const qs = new URLSearchParams();
          if (catLbl) qs.set('category', catLbl);
          location.href = `/pages/shop.html${qs.toString() ? '?' + qs.toString() : ''}`;
        }
      }, { passive: false });
    }

    function markFunctionalActive() {
      const hereCat = (getParam("category") || "").toLowerCase();
      if (!hereCat) return;
      let marked = false;
      qsa('#functionalNav a[data-category]').forEach(a => {
        const cat = (a.getAttribute('data-category') || "").toLowerCase();
        if (cat === hereCat) { a.classList.add('active'); marked = true; }
      });
      if (!marked && hereCat.includes("women")) {
        const top = qs('#functionalNav a[data-category="women"]');
        if (top) top.classList.add('active');
      }
      if (!marked && hereCat.includes("men")) {
        const top = qs('#functionalNav a[data-category="men"]');
        if (top) top.classList.add('active');
      }
    }

    /* ---------- Cart helpers (kept) ---------- */
    async function addToCart(slug, ev) {
      if (ev) { ev.preventDefault(); ev.stopPropagation(); }
      try {
        const out = await (await api("/api/cart/add", "POST", { slug, qty: 1 })).json();
        if (out && out.ok) alert("Added to cart!");
        else alert(out?.error || "Could not add to cart");
      } catch {
        alert("Could not add to cart");
      }
    }

    function closestCard(el) {
      while (el && !el.classList.contains('row-card')) el = el.parentElement;
      return el;
    }
    function getSelectedSizeFromCard(cardEl) {
      const selected = cardEl?.querySelector('.size-btn[aria-pressed="true"]');
      return selected ? selected.getAttribute('data-size') : null;
    }
    function toggleSizeButton(btn) {
      const card = closestCard(btn);
      card.querySelectorAll('.size-btn').forEach(b => b.removeAttribute('aria-pressed'));
      btn.setAttribute('aria-pressed','true');
      const add = card.querySelector('.add-btn');
      if (add) add.disabled = false;
    }
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.size-btn');
      if (btn) { e.preventDefault(); toggleSizeButton(btn); }
    });
    async function addCardToCartWithSelectedSize(el, slug, ev) {
      ev?.preventDefault(); ev?.stopPropagation();
      const card = closestCard(el);
      const size = getSelectedSizeFromCard(card);
      if (!size) { alert("Please select a size"); return; }
      try {
        const out = await (await api("/api/cart/add", "POST", { slug, qty: 1, size })).json();
        if (out && out.ok) alert(`Added size ${size} to cart!`);
        else alert(out?.error || "Could not add to cart");
      } catch {
        alert("Could not add to cart");
      }
    }
    function formatPriceRupees(val) {
      if (val == null || Number.isNaN(Number(val))) return "";
      const n = Number(val);
      return "Rs. " + new Intl.NumberFormat("en-LK", { maximumFractionDigits: 0 }).format(n);
    }
    function renderCard(p) {
      const href  = '/pages/Productdetail.html?slug=' + encodeURIComponent(p.slug || p.id || '');
      const img   = p.imageUrl || '/assets/uploads/placeholder.png';
      const name  = p.name || 'Product';
      const desc  = p.description || p.desc || "";
      const numericPrice = (typeof p.price === 'number') ? p.price
                         : (p.priceCents != null ? Number(p.priceCents) : null);
      const priceText = formatPriceRupees(numericPrice);
      const hasSizes = Array.isArray(p.sizesArray) && p.sizesArray.length > 0;

      return `
        <div class="row-card group relative rounded-2xl overflow-hidden border bg-white shadow-sm hover:shadow-md transition-shadow">
          <a href="${href}" class="block">
            <div class="bg-gray-100 aspect-[3/4] relative">
              <img src="${img}" alt="${name}" class="w-full h-full object-cover" loading="lazy"/>
              <div class="pointer-events-none absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>

              <div class="pointer-events-none absolute inset-0 p-4 flex flex-col justify-end opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <div class="text-white text-xs sm:text-sm leading-snug max-h-[60%] overflow-auto">
                  ${desc ? desc.replace(/</g,"&lt;") : ""}
                </div>

                ${
                  hasSizes
                  ? `
                    <div class="pointer-events-auto mt-3 flex flex-wrap gap-2">
                      ${p.sizesArray.map(s => `
                        <button type="button" class="size-btn" data-size="${s}">${s}</button>
                      `).join('')}
                    </div>
                    <div class="pointer-events-auto mt-3">
                      <button type="button"
                        class="add-btn inline-flex items-center justify-center rounded-full bg-white text-black text-xs font-semibold px-4 py-2 hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                        onclick="addCardToCartWithSelectedSize(this, '${(p.slug||'').replace(/'/g,'\\\'')}', event)">
                        Add to Cart
                      </button>
                    </div>
                  `
                  : `
                    <div class="pointer-events-auto mt-3">
                      <button type="button"
                        class="inline-flex items-center justify-center rounded-full bg-white text-black text-xs font-semibold px-4 py-2 hover:opacity-90"
                        onclick="addToCart('${(p.slug||'').replace(/'/g,'\\\'')}', event)">
                        Add to Cart
                      </button>
                    </div>
                  `
                }
              </div>
            </div>
            <div class="p-4">
              <div class="text-base font-semibold leading-tight line-clamp-1">${name}</div>
              <div class="mt-1 text-sm font-bold" style="color: var(--beige);">${priceText}</div>
            </div>
          </a>
        </div>
      `;
    }

    /* ---------- Carousel helpers ---------- */
    function attachArrows(rowId) {
      const row = document.getElementById(rowId);
      if (!row) return;
      const wrapper = row.parentElement;
      const buttons = wrapper.querySelectorAll("[data-target='"+rowId+"']");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const dir = Number(btn.getAttribute("data-dir")) || 1;
          row.scrollBy({ left: dir * row.clientWidth, behavior: "smooth" });
        });
      });
    }

    function placeCards({ items, gridEl, rowEl, trackEl }) {
      if (!Array.isArray(items) || items.length === 0) {
        gridEl.innerHTML = '<div class="col-span-full py-2 text-sm text-[var(--neutral-700)]">Nothing to show yet.</div>';
        gridEl.classList.remove('hidden');
        rowEl.classList.add('hidden');
        return;
      }
      if (items.length <= 4) {
        gridEl.innerHTML = items.slice(0, 4).map(renderCard).join('');
        gridEl.classList.remove('hidden');
        rowEl.classList.add('hidden');
      } else {
        trackEl.innerHTML = items.map(renderCard).join('');
        rowEl.classList.remove('hidden');
        gridEl.classList.add('hidden');
      }
    }

    async function loadSection({ primaryUrl, fallbackUrl, fallbackField, gridId, rowId, trackId }) {
      const gridEl  = document.getElementById(gridId);
      const rowEl   = document.getElementById(rowId);
      const trackEl = document.getElementById(trackId);

      gridEl.innerHTML = '<div class="col-span-full py-2 text-sm text-[var(--neutral-700)]">Loading…</div>';
      gridEl.classList.remove('hidden');
      rowEl.classList.add('hidden');

      try {
        let res = await fetch(primaryUrl);
        let items;

        if (res.ok) {
          items = await res.json();
        } else {
          const allRes = await fetch(fallbackUrl);
          if (!allRes.ok) throw new Error('API error');
          const all = await allRes.json();
          items = Array.isArray(all) ? all.filter(p => p && p[fallbackField]) : [];
        }

        items = (items || []).map(p => ({ ...p, sizesArray: normalizeSizes(p) }));

        placeCards({ items, gridEl, rowEl, trackEl });
        attachArrows(rowId);
      } catch (err) {
        console.error(err);
        gridEl.innerHTML = '<div class="col-span-full py-2 text-sm text-red-600">Could not load items.</div>';
        gridEl.classList.remove('hidden');
        rowEl.classList.add('hidden');
      }
    }

    /* ---------- Init ---------- */
    (async function init() {
      await buildFunctionalMenu();

      loadSection({
        primaryUrl: '/api/products/new',
        fallbackUrl: '/api/products',
        fallbackField: 'isNew',
        gridId: 'newArrivalsGrid',
        rowId: 'newArrivalsRow',
        trackId: 'newArrivalsTrack'
      });

      loadSection({
        primaryUrl: '/api/products/best',
        fallbackUrl: '/api/products',
        fallbackField: 'isBestSeller',
        gridId: 'bestSellersGrid',
        rowId: 'bestSellersRow',
        trackId: 'bestSellersTrack'
      });
    })();
  </script>
</body>
</html>
